<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SEO and Sharing Meta Tags -->
    <title>AI Educational Assistant</title>
    <meta name="description" content="A suite of specialized AI-powered tools for educators, designed to assist with item writing, lesson planning, and more. Compiled by Derrick Musamali.">
    <meta name="author" content="Derrick Musamali">
    <link rel="icon" href="https://raw.githubusercontent.com/derikmusa/ai-suite-assets/main/logo.jpeg" type="image/jpeg">

    <!-- Open Graph (Facebook, WhatsApp, etc.) -->
    <meta property="og:title" content="AI Educational Assistant Suite">
    <meta property="og:description" content="A collection of specialized AI tools for educators.">
    <meta property="og:image" content="https://raw.githubusercontent.com/derikmusa/ai-suite-assets/main/logo.jpeg">
    <meta property="og:type" content="website">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI Educational Assistant Suite">
    <meta name="twitter:description" content="A collection of specialized AI tools for educators.">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/derikmusa/ai-suite-assets/main/logo.jpeg">

    <!--
      ******************************************************************
      * GOOGLE ANALYTICS SCRIPT
      ******************************************************************
    -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YCTLDP04EJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YCTLDP04EJ');
    </script>

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        html, body, #root { height: 100%; }
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; } /* Prevent body scroll */
        #root { overflow-y: auto; } /* Allow root to scroll if needed */
        /* Custom scrollbar for a cleaner look */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px;}

        /* Markdown content styling */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-content h1 { font-size: 1.5em; } .markdown-content h2 { font-size: 1.25em; } .markdown-content h3 { font-size: 1.1em; }
        .markdown-content p { margin-bottom: 0.75rem; }
        .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-content ul { list-style-type: disc; } .markdown-content ol { list-style-type: decimal; }
        .markdown-content li { margin-bottom: 0.25rem; }

        /* MODIFICATION: This is the primary fix for tables on all devices. */
        .markdown-content table {
            display: block; /* Important for overflow to work */
            width: 100%;
            overflow-x: auto; /* This enables horizontal scrolling */
            border-collapse: collapse;
            margin-bottom: 1rem;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            white-space: nowrap; /* Prevents text from wrapping to the next line, forcing the table to be wide */
        }
        .markdown-content th { background-color: #f3f4f6; font-weight: 600; }

        .markdown-content blockquote { border-left: 4px solid #d1d5db; padding-left: 1rem; margin-left: 0; color: #4b5563; }
        .markdown-content code { background-color: #e5e7eb; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-family: monospace; }
        .markdown-content pre > code { display: block; padding: 0.75rem; white-space: pre-wrap; }

        /* Blinking cursor for streaming effect */
        .blinking-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2rem;
            background-color: #4f46e5;
            animation: blink 1s step-end infinite;
            vertical-align: bottom;
        }
        @keyframes blink {
            from, to { background-color: transparent }
            50% { background-color: #4f46e5; }
        }

        /* Loading spinner for API calls */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Auto-resizing textarea */
        textarea#chat-input {
            min-height: 48px;
            height: 48px;
        }

        /* Resizable sidebar handle */
        .resize-handle {
            position: absolute;
            top: 0;
            right: -2px;
            width: 4px;
            height: 100%;
            cursor: col-resize;
            background-color: transparent;
            z-index: 50;
        }
        .resize-handle:hover {
            background-color: #4f46e5;
        }

        /* Star rating styles */
        .star-rating .star {
            cursor: pointer;
            color: #d1d5db; /* gray-400 */
            transition: color 0.2s;
        }
        /* MODIFICATION: Corrected star rating hover logic. */
        .star-rating .star.hover,
        .star-rating .star.selected {
            color: #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef, useCallback } = React;

      // --- SVG ICONS ---
      const Icon = ({ C, ...props }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{C}</svg>;
      const SendIcon = (props) => <Icon {...props} C={<><path d="m22 2-7 20-4-9-9-4Z" /><path d="M22 2 11 13" /></>} />;
      const PaperclipIcon = (props) => <Icon {...props} C={<><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"/></>} />;
      const FileIcon = (props) => <Icon {...props} C={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></>} />;
      const XIcon = (props) => <Icon {...props} C={<><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>} />;
      const TrashIcon = (props) => <Icon {...props} C={<><path d="M3 6h18" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>} />;
      const HomeIcon = (props) => <Icon {...props} C={<><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></>} />;
      const MenuIcon = (props) => <Icon {...props} C={<><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></>} />;
      const AlertTriangleIcon = (props) => <Icon {...props} C={<><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />;
      const ChevronUpIcon = (props) => <Icon {...props} C={<polyline points="18 15 12 9 6 15"/>} />;
      const ChevronDownIcon = (props) => <Icon {...props} C={<polyline points="6 9 12 15 18 9"/>} />;
      const CopyIcon = (props) => <Icon {...props} C={<><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></>} />;
      const MoreVerticalIcon = (props) => <Icon {...props} C={<><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></>} />;
      const CheckCircleIcon = (props) => <Icon {...props} C={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
      const AlertCircleIcon = (props) => <Icon {...props} C={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />;
      const StarIcon = (props) => <Icon {...props} C={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>} />;
      const Share2Icon = (props) => <Icon {...props} C={<><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></>} />;

      // NEW: Colorful, brand-aligned contact icons
      const NewPhoneIcon = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" {...props}><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.02l-2.2 2.2z"/></svg>;
      const NewEnvelopeIcon = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" {...props}><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>;
      const NewWhatsAppIcon = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#25D366" {...props}><path d="M19.11 4.9a9.88 9.88 0 0 0-14.22 0 9.88 9.88 0 0 0 0 14.22l-2.09 2.09 2.23 2.23 2.09-2.09a9.88 9.88 0 0 0 14.22 0c3.89-3.89 3.89-10.33 0-14.22zM12 19.94a7.94 7.94 0 0 1-6.4-12.84l.09-.09.09-.09a7.94 7.94 0 0 1 12.62 0l.09.09.09.09A7.94 7.94 0 0 1 12 19.94zm-1.1-6.61h-2.26v-1.5h2.26v-2.26h1.5v2.26h2.26v1.5h-2.26v2.26h-1.5z"/></svg>;


      // --- CONFIGURATION ---
      const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxZHjqJoIwvdsXE_wrr8Dil9vIFvrv9BKe7ZZln8LtkEbOgLcPrzust6K-MSN7NcLZN/exec';


      // USER-EDITABLE SETTING: Change this number to set how many generations trigger the feedback pop-up.
      const FEEDBACK_TRIGGER_COUNT = 3;

      const PromptManager = {
        cache: {},
        availableAssistants: [],
        async getAvailableAssistants() {
          try {
            const response = await fetch(`${GAS_WEB_APP_URL}?action=getAssistants`);
            const data = await response.json();
            if (data.success) {
              this.availableAssistants = data.assistants;
              return data.assistants;
            }
            throw new Error(data.error || 'Failed to fetch assistants');
          } catch (error) {
            console.error('Error fetching assistants:', error);
            return [
              "Item Writer", "Lesson Notes Generator", "Lesson Plans (with Biblical values)", "Lesson Plans (no Biblical values)",
              "Mark Scheme Generator", "Scheme of Work (with Biblical values)", "Scheme of Work (no Biblical values)",
              "Student Workbook", "UCE Project Work Assistant", "Lab Assistant"
            ];
          }
        },
        async getPromptContent(assistantName) {
          if (this.cache[assistantName]) return this.cache[assistantName];
          try {
            const response = await fetch(`${GAS_WEB_APP_URL}?action=getPrompt&assistant=${encodeURIComponent(assistantName)}`);
            const data = await response.json();
            if (data.success && data.prompt && data.prompt.trim() !== '') {
              this.cache[assistantName] = data.prompt;
              return data.prompt;
            }
            return null;
          } catch (error) {
            console.error(`Error fetching prompt for ${assistantName}:`, error);
            return null;
          }
        },
        clearCache() { this.cache = {}; }
      };

      const AI_PROVIDERS = [
        { key: 'google', label: 'Google Gemini', apiKeyName: 'googleApiKey', apiKeyUrl: 'https://aistudio.google.com/app/apikey', apiHost: 'https://generativelanguage.googleapis.com', models: [
            { name: 'gemini-2.5-pro', vision: true }, { name: 'gemini-2.5-flash', vision: true }, { name: 'gemini-1.5-pro-latest', vision: true }, { name: 'gemini-1.5-flash-latest', vision: true }
        ]},
        { key: 'openai', label: 'OpenAI GPT', apiKeyName: 'openaiApiKey', apiKeyUrl: 'https://platform.openai.com/api-keys', apiHost: 'https://api.openai.com', models: [
            { name: 'gpt-4o', vision: true }, { name: 'gpt-4-turbo', vision: true }, { name: 'gpt-3.5-turbo', vision: false }
        ]},
        { key: 'anthropic', label: 'Anthropic Claude', apiKeyName: 'anthropicApiKey', apiKeyUrl: 'https://console.anthropic.com/settings/keys', apiHost: 'https://api.anthropic.com', models: [
            { name: 'claude-3-opus-20240229', vision: true }, { name: 'claude-3-sonnet-20240229', vision: true }, { name: 'claude-3-haiku-20240307', vision: true }
        ]},
        { key: 'groq', label: 'Llama 3 (via Groq)', apiKeyName: 'groqApiKey', apiKeyUrl: 'https://console.groq.com/keys', apiHost: 'https://api.groq.com/openai', models: [
            { name: 'llama3-8b-8192', vision: false }, { name: 'llama3-70b-8192', vision: false }
        ]},
      ];

      // --- COMPONENTS ---
      const MarkdownRenderer = ({ content, isLoading }) => {
          if (isLoading && !content) {
              return (
                  <div className="flex items-center gap-2 text-slate-500">
                      <div className="loading-spinner"></div>
                      <span>AI is thinking...</span>
                  </div>
              )
          }
          const html = marked.parse(content || '');
          return <div className="markdown-content" dangerouslySetInnerHTML={{ __html: html + (isLoading ? '<span class="blinking-cursor"></span>' : '') }} />;
      };

      const FeedbackModal = ({ isOpen, onClose, onSubmit, assistantName }) => {
        const [rating, setRating] = useState(0);
        const [hoverRating, setHoverRating] = useState(0);
        const [feedbackText, setFeedbackText] = useState('');
        const [email, setEmail] = useState('');
        const [isEmailValid, setIsEmailValid] = useState(null);
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [submitStatus, setSubmitStatus] = useState(null);

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        const handleEmailChange = (e) => {
            const newEmail = e.target.value;
            setEmail(newEmail);
            if (newEmail === '') {
                setIsEmailValid(null);
            } else {
                setIsEmailValid(emailRegex.test(newEmail));
            }
        };

        const handleSubmit = async () => {
          if ((rating === 0 && email === '') || (email !== '' && !isEmailValid)) return;
          setIsSubmitting(true);
          setSubmitStatus(null);
          try {
            await onSubmit({ rating: rating > 0 ? rating : null, feedbackText, assistantName, email: isEmailValid ? email : null });
            setSubmitStatus('success');
            setTimeout(() => {
                onClose();
                setSubmitStatus(null);
                setRating(0);
                setFeedbackText('');
                setEmail('');
                setIsEmailValid(null);
            }, 2000);
          } catch (error) {
            console.error("Submission failed:", error);
            setSubmitStatus('error');
          } finally {
            setIsSubmitting(false);
          }
        };

        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-2xl p-6 sm:p-8 max-w-md w-full transform transition-all scale-100 opacity-100">
                    {submitStatus === 'success' ? (
                        <div className="text-center py-8">
                            <CheckCircleIcon className="w-16 h-16 text-green-500 mx-auto mb-4" />
                            <h2 className="text-2xl font-bold text-slate-800">Thank You!</h2>
                            <p className="text-slate-600 mt-2">Your submission has been received.</p>
                        </div>
                    ) : (
                        <>
                            <h2 className="text-2xl font-bold text-slate-800 text-center">Enjoying the App?</h2>
                            <p className="text-slate-600 text-center mt-2 mb-6">Your feedback helps improve this tool. Please rate your experience or sign up for updates.</p>

                            <div className="flex justify-center items-center mb-6 star-rating" onMouseLeave={() => setHoverRating(0)}>
                                {[1, 2, 3, 4, 5].map(star => (
                                    <div key={star} onMouseEnter={() => setHoverRating(star)} onClick={() => setRating(star)}>
                                        {/* MODIFICATION: Corrected star classes for proper hover effect */}
                                        <StarIcon className={`w-10 h-10 star ${(hoverRating >= star) ? 'hover' : ''} ${rating >= star ? 'selected' : ''}`} style={{fill: 'currentColor'}}/>
                                    </div>
                                ))}
                            </div>

                            <textarea
                                value={feedbackText}
                                onChange={(e) => setFeedbackText(e.target.value)}
                                placeholder="Optional: Tell me more about your experience..."
                                className="w-full mt-1 p-3 bg-slate-100 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
                                rows="3"
                            />

                            <div className="mt-4">
                                <label htmlFor="email-signup" className="text-sm font-medium text-slate-700">Get notified about future updates</label>
                                <div className="relative mt-1">
                                    <input
                                        id="email-signup"
                                        type="email"
                                        value={email}
                                        onChange={handleEmailChange}
                                        placeholder="your.email@example.com"
                                        className={`w-full p-3 pr-10 bg-slate-100 border rounded-md focus:outline-none focus:ring-2 transition ${isEmailValid === true ? 'border-green-500 focus:ring-green-500' : isEmailValid === false ? 'border-red-500 focus:ring-red-500' : 'border-slate-300 focus:ring-indigo-500'}`}
                                    />
                                    <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        {isEmailValid === true && <CheckCircleIcon className="w-5 h-5 text-green-500" />}
                                        {isEmailValid === false && <AlertCircleIcon className="w-5 h-5 text-red-500" />}
                                    </div>
                                </div>
                            </div>

                            {submitStatus === 'error' && <p className="text-red-600 text-sm mt-2 text-center">Sorry, something went wrong. Please try again.</p>}

                            <div className="mt-6 flex flex-col sm:flex-row gap-3">
                                <button onClick={onClose} className="w-full px-6 py-3 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300 transition-colors">
                                    Not Now
                                </button>
                                <button onClick={handleSubmit} disabled={(rating === 0 && !isEmailValid) || isSubmitting} className="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors disabled:bg-indigo-300 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                    {isSubmitting && <div className="loading-spinner !border-white !border-t-transparent"></div>}
                                    Submit
                                </button>
                            </div>
                        </>
                    )}
                </div>
            </div>
        );
      };

      function App() {
        // --- STATE MANAGEMENT ---
        const getAssistantFromURL = () => new URLSearchParams(window.location.search).get('assistant') || 'Item Writer';

        const [apiKeys, setApiKeys] = useState({});
        const [apiKeyStatus, setApiKeyStatus] = useState({});
        const [sidebarWidth, setSidebarWidth] = useState(320);
        const [selectedProviderKey, setSelectedProviderKey] = useState('google');
        const [selectedModelName, setSelectedModelName] = useState('gemini-2.5-flash');
        const [autoDeleteHours, setAutoDeleteHours] = useState('2');
        const [chatHistory, setChatHistory] = useState([]);
        const [pendingFile, setPendingFile] = useState(null);
        const [pendingFilePreview, setPendingFilePreview] = useState(null);
        const [userInput, setUserInput] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState('');
        const [customPromptContent, setCustomPromptContent] = useState('');
        const [activePromptKey, setActivePromptKey] = useState(getAssistantFromURL());
        const [isMenuOpen, setIsMenuOpen] = useState(false);
        const [isPromptMissing, setIsPromptMissing] = useState(false);
        const [availableAssistants, setAvailableAssistants] = useState([]);
        const [isLoadingAssistants, setIsLoadingAssistants] = useState(true);
        const [navigationMenu, setNavigationMenu] = useState({});
        const [openMenuIndex, setOpenMenuIndex] = useState(null);
        const [showCopyToast, setShowCopyToast] = useState(false);
        const [apiKeyToast, setApiKeyToast] = useState('');
        const [generationCount, setGenerationCount] = useState(0);
        const [isFeedbackModalOpen, setIsFeedbackModalOpen] = useState(false);


        // --- REFS ---
        const chatContainerRef = useRef(null);
        const chatEndRef = useRef(null);
        const userInputRef = useRef(null);
        const validationTimeoutRef = useRef(null);
        const apiKeyToastTimeoutRef = useRef(null);

        // --- DERIVED STATE ---
        const selectedProvider = AI_PROVIDERS.find(p => p.key === selectedProviderKey);
        const selectedModel = selectedProvider?.models.find(m => m.name === selectedModelName);
        const isFileUploadDisabled = !selectedModel?.vision;

        // --- EFFECTS ---
        useEffect(() => {
            const savedCount = parseInt(localStorage.getItem('generationCount') || '0', 10);
            setGenerationCount(savedCount);

            const initializeAssistants = async () => {
                setIsLoadingAssistants(true);
                const assistants = await PromptManager.getAvailableAssistants();
                setAvailableAssistants(assistants);
                const menu = {};
                assistants.forEach(assistant => {
                    menu[assistant] = `?assistant=${encodeURIComponent(assistant)}`;
                });
                setNavigationMenu(menu);
                setIsLoadingAssistants(false);
            };
            initializeAssistants();
        }, []);

        useEffect(() => {
            const currentPromptKey = getAssistantFromURL();
            setActivePromptKey(currentPromptKey);
            document.title = `${currentPromptKey} | AI Assistant`;

            const savedState = JSON.parse(localStorage.getItem('aiAssistantState')) || {};
            setApiKeys(savedState.apiKeys || {});
            setApiKeyStatus(savedState.apiKeyStatus || {});
            setSidebarWidth(savedState.sidebarWidth || 320);
            setSelectedProviderKey(savedState.selectedProviderKey || 'google');
            setSelectedModelName(savedState.selectedModelName || 'gemini-2.5-flash');
            setAutoDeleteHours(savedState.autoDeleteHours || '2');

            const initializeChat = async () => {
                const chatKey = `chatHistory_${currentPromptKey}`;
                const savedChat = JSON.parse(localStorage.getItem(chatKey));
                const hours = parseFloat(savedState.autoDeleteHours || '2');
                if (savedChat && (savedState.autoDeleteHours === 'never' || (Date.now() - savedChat.timestamp) / 36e5 < hours)) {
                    setChatHistory(savedChat.history);
                    setIsPromptMissing(false);
                    return;
                }

                const promptContent = await PromptManager.getPromptContent(currentPromptKey);

                if (!promptContent) {
                    setIsPromptMissing(true);
                    setChatHistory([]);
                } else {
                    setIsPromptMissing(false);
                    let finalMessage = `${currentPromptKey} assistant is ready. How can I assist you?`;
                    try {
                        const promptJson = JSON.parse(promptContent);
                        const intro = promptJson?.interaction_flow?.introduction_message?.display_text;
                        if (intro) finalMessage = intro.replace(/\\n/g, '\n');
                    } catch(e) { /* Not JSON, use default */ }
                    setChatHistory([{ role: 'assistant', content: finalMessage }]);
                }
            };

            if (!isLoadingAssistants) {
                initializeChat();
            }
        }, [window.location.search, isLoadingAssistants]);

        useEffect(() => {
            localStorage.setItem('aiAssistantState', JSON.stringify({ apiKeys, apiKeyStatus, sidebarWidth, selectedProviderKey, selectedModelName, autoDeleteHours }));
        }, [apiKeys, apiKeyStatus, sidebarWidth, selectedProviderKey, selectedModelName, autoDeleteHours]);

        useEffect(() => {
            if (chatHistory && chatHistory.length > 0 && !chatHistory[chatHistory.length - 1]?.isLoading) {
                 const chatKey = `chatHistory_${activePromptKey}`;
                 localStorage.setItem(chatKey, JSON.stringify({ history: chatHistory, timestamp: Date.now() }));
            }
        }, [chatHistory, activePromptKey]);

        // MODIFICATION: Updated feedback logic to trigger after 3 generations, max twice per 24 hours.
        useEffect(() => {
            localStorage.setItem('generationCount', generationCount.toString());

            if (generationCount > 0 && generationCount % FEEDBACK_TRIGGER_COUNT === 0) {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                let feedbackTimestamps = JSON.parse(localStorage.getItem('feedbackTimestamps') || '[]');

                // Filter out timestamps older than 24 hours
                feedbackTimestamps = feedbackTimestamps.filter(ts => now - ts < oneDay);

                // Show modal only if it has been shown less than twice in the last 24 hours
                if (feedbackTimestamps.length < 2) {
                    setIsFeedbackModalOpen(true);
                    feedbackTimestamps.push(now);
                    localStorage.setItem('feedbackTimestamps', JSON.stringify(feedbackTimestamps));
                }
            }
        }, [generationCount]);

        useEffect(() => {
            const textarea = userInputRef.current;
            if (textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = `${textarea.scrollHeight}px`;
                const stopTouchPropagation = (e) => e.stopPropagation();
                textarea.addEventListener('touchmove', stopTouchPropagation);
                return () => textarea.removeEventListener('touchmove', stopTouchPropagation);
            }
        }, [userInput]);

        useEffect(() => {
            chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [chatHistory[chatHistory.length - 1]?.content]);

        // --- HANDLERS & LOGIC ---
        const validateApiKey = useCallback(async (provider, key) => {
            if (!key) {
                setApiKeyStatus(prev => ({ ...prev, [provider.key]: 'unchecked' }));
                return;
            }
            setApiKeyStatus(prev => ({ ...prev, [provider.key]: 'checking' }));
            let isValid = false;
            try {
                let response;
                if (provider.key === 'google') {
                    response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                } else if (provider.key === 'openai' || provider.key === 'groq') {
                    response = await fetch(`${provider.apiHost}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` }});
                } else if (provider.key === 'anthropic') {
                    response = await fetch(`${provider.apiHost}/v1/messages`, {
                        method: 'POST',
                        headers: { 'x-api-key': key, 'anthropic-version': '2023-06-01', 'content-type': 'application/json' },
                        body: JSON.stringify({ model: "claude-3-haiku-20240307", max_tokens: 1, messages: [{role: "user", content: "ping"}] })
                    });
                }
                if (response.ok) {
                    isValid = true;
                    setApiKeyStatus(prev => ({ ...prev, [provider.key]: 'valid' }));
                }
            } catch (error) {}

            if (!isValid) {
                setApiKeyStatus(prev => ({ ...prev, [provider.key]: 'invalid' }));
                setApiKeyToast(`Invalid ${provider.label} API Key`);
                if (apiKeyToastTimeoutRef.current) clearTimeout(apiKeyToastTimeoutRef.current);
                apiKeyToastTimeoutRef.current = setTimeout(() => setApiKeyToast(''), 3000);
            }

        }, []);

        const handleApiKeyChange = (keyName, provider, value) => {
            setApiKeys(prev => ({...prev, [keyName]: value}));
            if (validationTimeoutRef.current) clearTimeout(validationTimeoutRef.current);
            if (!value) {
                 setApiKeyStatus(prev => ({ ...prev, [provider.key]: 'unchecked' }));
                 return;
            }
            setApiKeyStatus(prev => ({ ...prev, [provider.key]: 'checking' }));
            validationTimeoutRef.current = setTimeout(() => {
                validateApiKey(provider, value);
            }, 800);
        };

        const handleFeedbackSubmit = async (submissionData) => {
            const payload = {
                action: 'submitFeedback',
                ...submissionData
            };

            await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload)
            });
        };


        const processFileForApi = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) reject("No file provided");
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({ mime_type: file.type, data: reader.result.split(',')[1] });
                reader.onerror = (error) => reject(error);
            });
        };

        const handleShare = async (shareData) => {
            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.error("Share failed:", err);
                }
            } else {
                navigator.clipboard.writeText(shareData.text || shareData.url);
                setShowCopyToast(true);
                setTimeout(() => setShowCopyToast(false), 3000);
            }
            setOpenMenuIndex(null);
        };

        const handleCopy = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                setShowCopyToast(true);
                setTimeout(() => setShowCopyToast(false), 3000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                setError("Failed to copy text to clipboard.");
            });
            setOpenMenuIndex(null);
        };

        const handleSendMessage = async () => {
            const apiKey = apiKeys[selectedProvider.apiKeyName];
            if ((!userInput.trim() && !pendingFile) || isLoading) return;
            if (!apiKey || apiKeyStatus[selectedProvider.key] !== 'valid') {
                setError(`Please enter a valid ${selectedProvider.label} API Key in the settings panel.`);
                setIsMenuOpen(true);
                return;
            }

            setIsLoading(true);
            setError('');

            let fileDataForApi = null;
            if (pendingFile && !isFileUploadDisabled) {
                try {
                    fileDataForApi = await processFileForApi(pendingFile);
                } catch(e) {
                    setError("Could not read file.");
                    setIsLoading(false);
                    return;
                }
            }

            const userMessage = { role: 'user', content: userInput, file: pendingFile ? { name: pendingFile.name, previewUrl: pendingFilePreview } : null, fileDataForApi };
            const newHistory = [...chatHistory, userMessage, { role: 'assistant', content: '', isLoading: true }];
            setChatHistory(newHistory);
            setUserInput(''); setPendingFile(null); setPendingFilePreview(null);

            let systemPrompt = activePromptKey === 'custom' ? customPromptContent : await PromptManager.getPromptContent(activePromptKey);
            if (!systemPrompt) {
                setError('Failed to load assistant configuration. Please try again.');
                setChatHistory(prev => prev.slice(0, -1));
                setIsLoading(false);
                return;
            }

            const historyForApi = newHistory.slice(0, -1);

            try {
                let requestUrl, requestHeaders, requestBody;

                if (selectedProvider.key === 'google') {
                    requestUrl = `${selectedProvider.apiHost}/v1beta/models/${selectedModel.name}:streamGenerateContent?key=${apiKey}&alt=sse`;
                    requestHeaders = { 'Content-Type': 'application/json' };
                    const geminiMessages = historyForApi.map(msg => {
                        const parts = [{ text: msg.content || "" }];
                        if (msg.role === 'user' && msg.fileDataForApi) {
                            parts.push({ inline_data: { mime_type: msg.fileDataForApi.mime_type, data: msg.fileDataForApi.data } });
                        }
                        return { role: msg.role === 'user' ? 'user' : 'model', parts };
                    });
                    requestBody = JSON.stringify({ contents: geminiMessages, systemInstruction: { parts: [{ text: systemPrompt }] } });
                } else {
                    requestUrl = `${selectedProvider.apiHost}/v1/chat/completions`;
                    requestHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };
                    if (selectedProvider.key === 'anthropic') {
                         requestHeaders = { 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'content-type': 'application/json' };
                    }
                    const messages = historyForApi.map(msg => {
                        const content = [{ type: 'text', text: msg.content || "" }];
                        if (msg.role === 'user' && msg.fileDataForApi) {
                            content.push({ type: 'image_url', image_url: { url: `data:${msg.fileDataForApi.mime_type};base64,${msg.fileDataForApi.data}` } });
                        }
                        return { role: msg.role, content: content.length === 1 && content[0].type === 'text' ? content[0].text : content };
                    });
                    const systemMessage = selectedProvider.key === 'anthropic' ? { system: systemPrompt } : { messages: [{role: 'system', content: systemPrompt}, ...messages] };
                    const requestMessages = selectedProvider.key === 'anthropic' ? { messages } : {};

                    requestBody = JSON.stringify({
                        model: selectedModel.name,
                        ...systemMessage,
                        ...requestMessages,
                        stream: true,
                        max_tokens: 4096
                    });
                }

                const response = await fetch(requestUrl, { method: 'POST', headers: requestHeaders, body: requestBody });
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || `API request failed with status ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.substring(6);
                            if (dataStr.trim() === '[DONE]') break;
                            try {
                                const data = JSON.parse(dataStr);
                                let textChunk = '';
                                if (selectedProvider.key === 'google') textChunk = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                else textChunk = data.choices?.[0]?.delta?.content || data.delta?.text || '';

                                if (textChunk) {
                                    setChatHistory(prev => {
                                        const newHistory = [...prev];
                                        const lastMsg = newHistory[newHistory.length - 1];
                                        if (lastMsg) {
                                            lastMsg.content += textChunk;
                                        }
                                        return newHistory;
                                    });
                                 }
                            } catch (e) { /* Ignore parsing errors */ }
                        }
                    }
                }

            } catch (err) {
                setError(err.message);
                setChatHistory(prev => prev.slice(0, -1));
            } finally {
                setChatHistory(prev => {
                    const newHistory = [...prev];
                    const lastMsg = newHistory[newHistory.length - 1];
                    if (lastMsg) {
                        lastMsg.isLoading = false;
                    }
                    return newHistory;
                });
                setIsLoading(false);
                setGenerationCount(prevCount => prevCount + 1);
            }
        };

        const handleProviderChange = (e) => {
            const newProviderKey = e.target.value;
            setSelectedProviderKey(newProviderKey);
            setSelectedModelName(AI_PROVIDERS.find(p => p.key === newProviderKey).models[0].name);
        };

        const handleFileSelect = (e) => {
            const file = e.target.files[0];
            if (file && !isFileUploadDisabled) {
                setPendingFile(file);
                if (file.type.startsWith('image/')) { setPendingFilePreview(URL.createObjectURL(file)); }
                else { setPendingFilePreview(null); }
            }
        };

        const handleCustomPromptUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                setCustomPromptContent(text);
                setActivePromptKey('custom');
                setIsPromptMissing(false);
                setChatHistory([{ role: 'assistant', content: 'Custom prompt loaded. How can I assist?' }]);
            } catch (err) { setError('Could not read custom prompt file.'); }
        };

        const handlePromptSelectionChange = (e) => {
            if (e.target.value) {
                try {
                    const url = new URL(e.target.value, window.location.origin);
                    const newAssistantKey = url.searchParams.get('assistant');
                    if (newAssistantKey) {
                        const chatKey = `chatHistory_${newAssistantKey}`;
                        localStorage.removeItem(chatKey);
                    }
                } catch (error) {
                    console.error("Could not parse URL from selection:", e.target.value, error);
                }
                window.location.href = e.target.value;
            }
        };

        const clearChat = () => {
            const chatKey = `chatHistory_${activePromptKey}`;
            localStorage.removeItem(chatKey);
            localStorage.removeItem('generationCount');
            localStorage.removeItem('feedbackTimestamps');
            setGenerationCount(0);
            setPendingFile(null); setPendingFilePreview(null); setError('');
            window.location.reload();
        };

        const handleScroll = (direction) => {
            const container = chatContainerRef.current;
            if (container) {
                const scrollAmount = container.clientHeight * 0.8;
                container.scrollBy({ top: direction === 'up' ? -scrollAmount : scrollAmount, behavior: 'smooth' });
            }
        };

        const startResizing = useCallback((mouseDownEvent) => {
            const handleMouseMove = (mouseMoveEvent) => {
                const newWidth = mouseDownEvent.clientX + (mouseMoveEvent.clientX - mouseDownEvent.clientX);
                if (newWidth > 280 && newWidth < 800) {
                    setSidebarWidth(newWidth);
                }
            };
            const handleMouseUp = () => {
                window.removeEventListener("mousemove", handleMouseMove);
                window.removeEventListener("mouseup", handleMouseUp);
            };
            window.addEventListener("mousemove", handleMouseMove);
            window.addEventListener("mouseup", handleMouseUp);
        }, []);

        // --- RENDER ---
        if (isLoadingAssistants) {
            return <div className="flex items-center justify-center h-screen bg-slate-100"><div className="text-center"><div className="loading-spinner mx-auto mb-4"></div><p className="text-slate-600">Loading assistants...</p></div></div>;
        }

        if (isPromptMissing) {
            return (
                <div className="flex items-center justify-center h-screen bg-slate-100 p-4">
                    <div className="text-center bg-white p-8 rounded-lg shadow-lg max-w-lg">
                        <AlertTriangleIcon className="w-16 h-16 text-amber-500 mx-auto mb-4" />
                        <h2 className="text-2xl font-bold text-slate-800 mb-2">Assistant Not Configured</h2>
                        <p className="text-slate-600 mb-4">The "{activePromptKey}" assistant has not been configured yet in the Google Apps Script.</p>
                        <p className="text-slate-600 mb-6">Please contact the administrator or select another assistant.</p>
                        <div className="bg-slate-50 p-4 rounded-lg">
                            <p className="text-slate-600 mb-3">Alternatively, you can upload a custom prompt in a `.txt` or `.json` file to start a session.</p>
                            <label htmlFor="custom-prompt-upload-error" className="w-full inline-block px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors cursor-pointer">Upload Custom Prompt</label>
                            <input id="custom-prompt-upload-error" type="file" className="hidden" accept=".txt,.json" onChange={handleCustomPromptUpload} />
                        </div>
                         <a href={window.location.pathname} className="mt-6 inline-flex items-center justify-center gap-2 text-slate-600 hover:text-slate-900 font-semibold"><HomeIcon className="w-5 h-5"/>Return to Home</a>
                    </div>
                </div>
            );
        }

        return (
            <div className="h-full w-full overflow-hidden flex bg-white">
                {/* --- SIDEBAR / SETTINGS PANEL --- */}
                <div
                    style={{ width: `${sidebarWidth}px`, maxWidth: '100vw' }}
                    className={`absolute lg:static top-0 left-0 h-full bg-slate-800 text-white flex flex-col z-40 transition-transform duration-300 ease-in-out transform ${isMenuOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}
                >
                    <div className="flex-1 flex flex-col min-h-0">
                        <div className="flex justify-between items-center p-4 flex-shrink-0">
                             <h1 className="text-2xl font-bold">Settings</h1>
                             <button onClick={() => setIsMenuOpen(false)} className="lg:hidden p-1 text-slate-400 hover:text-white"><XIcon className="w-6 h-6"/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-5">
                            <div>
                                <label className="text-sm text-slate-400">Select an Assistant</label>
                                <select onChange={handlePromptSelectionChange} value={navigationMenu[activePromptKey] || ""} className="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    {availableAssistants.map(assistant => (
                                        <option key={assistant} value={navigationMenu[assistant]}>{assistant}</option>
                                    ))}
                                    {activePromptKey === 'custom' && <option value="">Custom Prompt</option>}
                                </select>
                                 <label htmlFor="custom-prompt-upload" className="mt-2 text-sm text-indigo-400 hover:text-indigo-300 cursor-pointer block text-center py-2 border border-dashed border-slate-600 rounded-md hover:border-indigo-500 transition-colors">Upload Custom Prompt</label>
                                <input id="custom-prompt-upload" type="file" className="hidden" accept=".txt,.json" onChange={handleCustomPromptUpload} />
                            </div>
                            <div>
                                <label className="text-sm text-slate-400">AI Provider</label>
                                <select value={selectedProviderKey} onChange={handleProviderChange} className="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    {AI_PROVIDERS.map(p => <option key={p.key} value={p.key}>{p.label}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-sm text-slate-400">AI Model</label>
                                <select value={selectedModelName} onChange={(e) => setSelectedModelName(e.target.value)} className="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    {selectedProvider?.models.map(model => <option key={model.name} value={model.name}>{model.name}</option>)}
                                </select>
                            </div>
                             <div>
                                <label className="text-sm text-slate-400">{selectedProvider?.label} API Key</label>
                                <div className="relative">
                                    <input type="password" value={apiKeys[selectedProvider?.apiKeyName] || ''} onChange={(e) => handleApiKeyChange(selectedProvider.apiKeyName, selectedProvider, e.target.value)} placeholder={`Paste your ${selectedProvider?.label} key here`} className="w-full mt-1 p-2 pr-8 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                    <div className="absolute inset-y-0 right-0 flex items-center pr-2">
                                        {apiKeyStatus[selectedProvider.key] === 'checking' && <div className="loading-spinner"></div>}
                                        {apiKeyStatus[selectedProvider.key] === 'valid' && <CheckCircleIcon className="w-5 h-5 text-green-500"/>}
                                        {apiKeyStatus[selectedProvider.key] === 'invalid' && <AlertCircleIcon className="w-5 h-5 text-red-500"/>}
                                    </div>
                                </div>
                                <a href={selectedProvider?.apiKeyUrl} target="_blank" rel="noopener noreferrer" className="text-xs text-indigo-400 hover:underline mt-1 block">Get your key here &raquo;</a>
                            </div>
                            <div><label className="text-sm text-slate-400">Auto-delete Chat</label><select value={autoDeleteHours} onChange={(e) => setAutoDeleteHours(e.target.value)} className="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="1">After 1 Hour</option><option value="2">After 2 Hours</option><option value="24">After 24 Hours</option><option value="never">Never</option></select></div>
                        </div>
                        <div className="p-4 mt-auto space-y-3 flex-shrink-0 border-t border-slate-700">
                             <p className="text-sm text-slate-400 text-center">A Project by Derrick Musamali</p>
                             <div className="flex justify-center items-center gap-6 text-slate-400">
                                <a href="tel:+256750470234" title="Call" className="hover:text-white transition-colors">
                                    <NewPhoneIcon className="w-6 h-6"/>
                                </a>
                                <a href="https://wa.me/256750470234" target="_blank" rel="noopener noreferrer" title="WhatsApp" className="hover:opacity-80 transition-opacity">
                                    <NewWhatsAppIcon className="w-6 h-6"/>
                                </a>
                                <a href="mailto:musadrk2@gmail.com" title="Email" className="hover:text-white transition-colors">
                                    <NewEnvelopeIcon className="w-6 h-6 text-slate-400 hover:text-white"/>
                                </a>
                             </div>
                             <a href={window.location.pathname} className="flex items-center justify-center gap-2 w-full text-center mt-2 py-2 bg-slate-700 hover:bg-slate-600 rounded-md transition-colors"><HomeIcon className="w-5 h-5"/>Return to Home</a>
                        </div>
                    </div>
                    <div onMouseDown={startResizing} className="resize-handle hidden lg:block"></div>
                </div>

                {/* --- MAIN CHAT INTERFACE --- */}
                <div className="flex-1 flex flex-col h-full overflow-hidden">
                    <header className="p-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0 bg-white z-10">
                        <button onClick={() => setIsMenuOpen(true)} className="p-1 text-slate-600 hover:text-slate-900 lg:hidden"><MenuIcon className="w-6 h-6" /></button>
                        <h2 className="text-xl font-semibold text-slate-800 text-center flex-1">{activePromptKey} Assistant</h2>
                        <div className="flex items-center gap-2">
                            <button
                                onClick={() => handleShare({
                                    title: 'AI Educational Assistant',
                                    text: 'Check out this suite of AI-powered tools for educators!',
                                    url: window.location.href
                                })}
                                title="Share this app"
                                className="p-2 rounded-full hover:bg-slate-200"
                            >
                                <Share2Icon className="w-5 h-5 text-slate-500"/>
                            </button>
                            <button onClick={clearChat} title="Clear chat history and reset" className="p-2 rounded-full hover:bg-slate-200"><TrashIcon className="w-5 h-5 text-slate-500"/></button>
                        </div>
                    </header>

                    <main ref={chatContainerRef} className="flex-1 overflow-y-auto custom-scrollbar bg-slate-50 relative">
                        <div className="p-6 space-y-6">
                            {chatHistory.map((msg, index) => (
                                <div key={index} className={`flex w-full items-start gap-3 ${msg.role === 'user' ? 'justify-end' : ''}`}>
                                    {msg.role !== 'user' && (
                                        <div className="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-sm shrink-0">AI</div>
                                    )}
                                    <div className={`p-4 rounded-lg max-w-full overflow-hidden ${msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border border-slate-200'}`}>
                                        {msg.file && (
                                            <div className="mb-2 p-2 bg-indigo-500 rounded-md inline-block">
                                                {msg.file.previewUrl ? <img src={msg.file.previewUrl} className="max-w-xs rounded-md"/> : <div className="flex items-center gap-2 p-2"><FileIcon className="w-6 h-6"/><span>{msg.file.name}</span></div>}
                                            </div>
                                        )}
                                        <MarkdownRenderer content={msg.content} isLoading={msg.isLoading} />
                                    </div>
                                    {msg.role === 'assistant' && !msg.isLoading && msg.content && (
                                        <div className="relative">
                                            <button
                                                onClick={() => setOpenMenuIndex(openMenuIndex === index ? null : index)}
                                                className="p-2 rounded-full hover:bg-slate-200 text-slate-500"
                                                title="Options"
                                            >
                                                <MoreVerticalIcon className="w-5 h-5" />
                                            </button>
                                            {openMenuIndex === index && (
                                                <div className="absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg z-20 border border-slate-200">
                                                    <button
                                                        onClick={() => handleCopy(msg.content)}
                                                        className="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"
                                                    >
                                                        <CopyIcon className="w-4 h-4" />
                                                        <span>Copy</span>
                                                    </button>
                                                    <button
                                                        onClick={() => handleShare({ title: 'AI Assistant Response', text: msg.content })}
                                                        className="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"
                                                    >
                                                        <Share2Icon className="w-4 h-4" />
                                                        <span>Share</span>
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ))}
                            <div ref={chatEndRef} />
                        </div>
                        <div className="sticky bottom-4 right-4 float-right space-y-2">
                            <button onClick={() => handleScroll('up')} className="p-2 rounded-full bg-black bg-opacity-40 text-white hover:bg-opacity-60 transition-opacity"><ChevronUpIcon className="w-5 h-5"/></button>
                            <button onClick={() => handleScroll('down')} className="p-2 rounded-full bg-black bg-opacity-40 text-white hover:bg-opacity-60 transition-opacity"><ChevronDownIcon className="w-5 h-5"/></button>
                        </div>
                    </main>

                    {error && <div className="p-4 bg-red-100 text-red-700 border-t border-red-200 flex-shrink-0">{error}</div>}

                    <footer className="p-4 border-t border-slate-200 bg-white flex-shrink-0">
                        <div className="relative mx-auto">
                            {pendingFile && <div className="absolute bottom-full left-0 mb-2 max-w-md p-2"><div className="flex items-start gap-2 bg-slate-200 text-slate-700 rounded-lg p-2 text-sm">
                                {pendingFilePreview ? <img src={pendingFilePreview} alt="Preview" className="w-16 h-16 object-cover rounded-md"/> : <FileIcon className="w-12 h-12 text-slate-500 shrink-0"/>}
                                <div className="flex-grow"><p className="font-semibold">File attached:</p><p className="text-xs break-all">{pendingFile.name}</p></div>
                                <button onClick={() => {setPendingFile(null); setPendingFilePreview(null);}} className="p-1 rounded-full hover:bg-slate-300 shrink-0"><XIcon className="w-4 h-4" /></button>
                            </div></div>}
                            <div className="flex items-end gap-4">
                                <label htmlFor="file-upload" title={isFileUploadDisabled ? "File upload not supported by this model" : "Attach File"} className={`p-3 rounded-full hover:bg-slate-100 self-end ${isFileUploadDisabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}><PaperclipIcon className="w-6 h-6 text-slate-600"/></label>
                                <input id="file-upload" type="file" className="hidden" onChange={handleFileSelect} disabled={isFileUploadDisabled}/>
                                <textarea
                                    ref={userInputRef}
                                    id="chat-input"
                                    value={userInput}
                                    onChange={(e) => setUserInput(e.target.value)}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                            e.preventDefault();
                                            handleSendMessage();
                                        }
                                    }}
                                    placeholder="Type your message or attach a file..."
                                    className="flex-1 p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none overflow-y-auto max-h-48"
                                    rows="1"
                                />
                                <button onClick={handleSendMessage} disabled={isLoading} className="p-3 rounded-full bg-indigo-600 text-white disabled:bg-slate-300 transition-colors hover:bg-indigo-700 self-end">
                                    {isLoading ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <SendIcon className="w-6 h-6"/>}
                                </button>
                            </div>
                        </div>
                    </footer>
                </div>

                {/* --- TOAST NOTIFICATIONS --- */}
                {showCopyToast && (
                    <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-full shadow-lg z-50">
                        Copied to clipboard!
                    </div>
                )}
                {apiKeyToast && (
                    <div className="fixed top-5 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2">
                        <AlertCircleIcon className="w-5 h-5"/>
                        <span>{apiKeyToast}</span>
                    </div>
                )}

                {/* --- FEEDBACK MODAL --- */}
                <FeedbackModal
                    isOpen={isFeedbackModalOpen}
                    onClose={() => setIsFeedbackModalOpen(false)}
                    onSubmit={handleFeedbackSubmit}
                    assistantName={activePromptKey}
                />
            </div>
        );
      }
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
</body>
</html>
